<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora CLT</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
        integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-V6V4GKM00N"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-V6V4GKM00N');
    </script>
    <style>
        /* Definição das variáveis de cor para o tema claro (padrão) */
        :root {
            --bs-body-bg: #f8f9fa;
            --bs-body-color: #212529;
            --card-bg: #ffffff;
            --card-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1);
            --table-striped-bg: #f8f9fa;
            --info-bg: #e9f7ef;
            --danger-info-bg: #fbe9eb;
            --muted-text-color: #6c757d;
            --bs-border-color: #dee2e6;
        }

        /* Sobrescreve as variáveis para o tema escuro */
        [data-bs-theme="dark"] {
            --bs-body-bg: #212529;
            --bs-body-color: #dee2e6;
            --card-bg: #343a40;
            --card-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.5);
            --table-striped-bg: #2c3034;
            --info-bg: #1a3a2a;
            --danger-info-bg: #492f33;
            --muted-text-color: #adb5bd;
            --bs-border-color: #495057;
        }

        /* Aplica as variáveis aos elementos */
        body {
            background-color: var(--bs-body-bg);
            color: var(--bs-body-color);
            transition: background-color 0.3s, color 0.3s;
            display: flex;
            flex-direction: column;
            font-size: 0.90rem;
            /* Reduz a fonte */
            min-height: 100vh;
        }

        .card,
        .alert {
            background-color: var(--card-bg);
            border-color: var(--bs-border-color);
        }

        .text-muted {
            color: var(--muted-text-color) !important;
        }

        main {
            flex: 1;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .card {
            border-color: var(--bs-border-color);
            box-shadow: var(--card-shadow);
        }

        .table-striped>tbody>tr:nth-of-type(odd)>* {
            --bs-table-accent-bg: #f8f9fa;
        }

        .accordion-button:not(.collapsed) {
            color: #005c2b;
            background-color: #e9f7ef;
        }

        [data-bs-toggle="collapse"] {
            cursor: pointer;
        }

        pre {
            white-space: pre-wrap;
        }

        @media print {
            body * {
                visibility: hidden;
            }

            .printable-area,
            .printable-area * {
                visibility: visible;
            }

            .printable-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }

            .no-print {
                display: none !important;
            }
        }

        /* Ajustes de fonte na Navbar */
        .navbar-brand {
            font-size: 0.9rem !important;
        }

        .nav-link {
            font-size: 0.9rem !important;
        }

        @media (max-width: 991.98px) {
            .navbar-collapse {
                width: 100%;
            }
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark no-print">
        <div class="container">
            <a class="navbar-brand" href="#" onclick="showPage('page-home')">
                <i class="fas fa-calculator"></i> Calculadora CLT
            </a>
            <div class="d-flex align-items-center">
                <div class="form-check form-switch text-light d-flex align-items-center me-2 d-lg-none">
                    <input class="form-check-input" type="checkbox" role="switch" id="theme-switcher">
                    <label class="form-check-label ms-2" for="theme-switcher"><i class="fas fa-moon"></i></label>
                </div>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                    aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
            </div>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showPage('page-salario-form')">Calculadora de Salário</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showPage('page-rescisao-form')">Calculadora de
                            Rescisão</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showPage('page-historico')">Histórico</a>
                    </li>
                </ul>
                <div class="form-check form-switch text-light d-none d-lg-flex align-items-center">
                    <input class="form-check-input" type="checkbox" role="switch" id="theme-switcher-desktop">
                    <label class="form-check-label ms-2" for="theme-switcher-desktop"><i
                            class="fas fa-moon"></i></label>
                </div>
            </div>
        </div>
    </nav>

    <main class="container mt-4">
        <!-- PÁGINA INICIAL -->
        <div id="page-home" class="page active">Utilize o menu para navegação entre as funcionalidades da ferramenta.
        </div>

        <!-- PÁGINA FORMULÁRIO RESCISÃO -->
        <div id="page-rescisao-form" class="page">
            <h2>Calculadora de Rescisão</h2>
            <div class="row">
                <div class="col-lg-5">
                    <form id="form-rescisao" class="card p-4 mt-3">
                        <div class="mb-3">
                            <label class="form-label">Tipo de rescisão</label>
                            <select class="form-select" name="tipo_rescisao" id="tipo_rescisao">
                                <option value="sem_justa_causa">Demissão sem justa causa</option>
                                <option value="pedido_demissao">Pedido de demissão</option>
                                <option value="justa_causa">Demissão por justa causa</option>
                                <option value="acordo">Acordo entre as partes</option>
                                <option value="termino_contrato">Término de contrato de experiência</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label>Salário bruto mensal</label>
                            <input type="number" step="0.01" class="form-control" name="salario" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Dia do mês que a empresa paga o salário</label>
                            <input type="number" class="form-control" name="dia_pagamento" min="1" max="31" value="30"
                                required>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label>Data de início do contrato</label>
                                <input type="date" class="form-control" name="data_inicio" required>
                            </div>
                            <div class="col-md-6 mb-3" id="data_fim_div">
                                <label>Data do último dia trabalhado</label>
                                <input type="date" class="form-control" name="data_fim" required>
                            </div>
                        </div>

                        <hr>

                        <div id="aviso_pedido_demissao" style="display: none;">
                            <h5>Aviso Prévio (Pedido de Demissão)</h5>
                            <div class="mb-3">
                                <label>Data da solicitação da demissão</label>
                                <input type="date" class="form-control" name="data_solicitacao_demissao"
                                    id="data_solicitacao_demissao">
                            </div>
                            <div class="mb-3">
                                <label>Irá cumprir o aviso prévio de 30 dias?</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="cumprira_aviso" id="cumprira_sim"
                                        value="sim" checked>
                                    <label class="form-check-label" for="cumprira_sim">Sim, cumprirei
                                        integralmente</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="cumprira_aviso" id="cumprira_nao"
                                        value="nao">
                                    <label class="form-check-label" for="cumprira_nao">Não, sairei antes</label>
                                </div>
                            </div>
                            <div class="mb-3" id="data_saida_pretendida_div" style="display: none;">
                                <label>Se não, qual a data que pretende sair?</label>
                                <input type="date" class="form-control" name="data_saida_pretendida">
                            </div>
                        </div>

                        <div id="aviso_sem_justa_causa">
                            <h5>Aviso Prévio (Demissão sem Justa Causa)</h5>
                            <div class="mb-3">
                                <label>Tipo de Aviso Prévio</label>
                                <select class="form-select" name="tipo_aviso_sem_justa_causa"
                                    id="tipo_aviso_sem_justa_causa">
                                    <option value="indenizado">Indenizado (saída imediata)</option>
                                    <option value="trabalhado">Trabalhado</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-check my-3" id="ferias_vencidas_div" style="display: none;">
                            <input class="form-check-input" type="checkbox" name="tem_ferias_vencidas"
                                id="tem_ferias_vencidas">
                            <label class="form-check-label" for="tem_ferias_vencidas">
                                Possui férias vencidas e não gozadas?
                            </label>
                        </div>

                        <button class="btn btn-primary mt-4">Calcular</button>
                    </form>
                </div>
                <div class="col-lg-7">
                    <div id="resultado-rescisao-content" class="mt-3 printable-area">
                        <div class="card p-4" id="rescisao-placeholder">
                            <h3 class="text-center text-muted">Preencha os dados ao lado para ver o resultado.</h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <!-- PÁGINA SALÁRIO MENSAL -->
        <div id="page-salario-form" class="page">
            <h2>Calculadora de Salário Mensal</h2>
            <div class="row">
                <div class="col-lg-5">
                    <form id="form-salario" class="card p-4 mt-3">
                        <div class="mb-3">
                            <label for="salario_bruto" class="form-label">Salário Bruto Mensal (CLT)</label>
                            <input type="number" step="0.01" class="form-control" name="salario_bruto"
                                id="salario_bruto" required>
                        </div>
                        <div class="mb-3">
                            <label for="num_dependentes" class="form-label">Número de dependentes (para IRRF)</label>
                            <input type="number" class="form-control" name="num_dependentes" id="num_dependentes"
                                value="0">
                        </div>
                        <hr>
                        <p class="text-muted">Para a comparação CLT x PJ, informe os benefícios anuais:</p>
                        <div class="mb-3">
                            <label for="va_vr_mensal" class="form-label">Valor Mensal (VA/VR)</label>
                            <input type="number" step="0.01" class="form-control" name="va_vr_mensal" id="va_vr_mensal"
                                value="0">
                        </div>
                        <div class="mb-3">
                            <label for="bonus_anual" class="form-label">Bônus / PLR (Valor Anual)</label>
                            <input type="number" step="0.01" class="form-control" name="bonus_anual" id="bonus_anual"
                                value="0">
                        </div>
                        <button type="submit" class="btn btn-primary mt-3">Calcular Salário Líquido e Comparar com
                            PJ</button>
                    </form>
                </div>
                <div class="col-lg-7">
                    <div id="resultado-salario-content" class="mt-3 printable-area">
                        <div class="card p-4" id="salario-placeholder">
                            <h3 class="text-center text-muted">Preencha os dados ao lado para ver o resultado.</h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PÁGINA HISTÓRICO -->
        <div id="page-historico" class="page">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2>Histórico de Cálculos</h2>
                <div>
                    <button class="btn btn-outline-secondary btn-sm me-2" onclick="exportarHistorico()">
                        <i class="fas fa-download"></i> Exportar JSON
                    </button>
                    <button class="btn btn-outline-danger btn-sm" onclick="limparHistorico()">
                        <i class="fas fa-trash"></i> Limpar Tudo
                    </button>
                </div>
            </div>
            <div class="card p-0 mt-3 overflow-hidden">
                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="table-historico">
                        <thead class="table-dark">
                            <tr>
                                <th class="ps-3" style="width: 25%;">Data/Hora</th>
                                <th style="width: 20%;">Tipo</th>
                                <th style="width: 35%;">Destaque (Líquido)</th>
                                <th class="text-end pe-3" style="width: 20%;">Ação</th>
                            </tr>
                        </thead>
                        <tbody id="historico-body">
                            <!-- Inserido via JS -->
                        </tbody>
                    </table>
                </div>
                <div id="historico-vazio" class="p-5 text-center text-muted" style="display: none;">
                    <i class="fas fa-history fa-3x mb-3"></i>
                    <p>Nenhum cálculo realizado ainda.</p>
                </div>
            </div>
        </div>

    </main>

    <footer class="container text-start text-muted py-4 mt-5 no-print">
        <p>GABRL&copy; 2026</p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>

    <script>
        // ===================================================================================
        // LÓGICA DE NAVEGAÇÃO E CONTROLE DA UI
        // ===================================================================================

        const themeSwitcher = document.getElementById('theme-switcher');
        const themeSwitcherDesktop = document.getElementById('theme-switcher-desktop');
        const themeIcon = document.querySelector('label[for="theme-switcher"] i');
        const docElement = document.documentElement;

        function setIconForTheme(theme) {
            if (theme === 'dark') {
                themeIcon.classList.remove('fa-moon');
                themeIcon.classList.add('fa-sun');
            } else {
                themeIcon.classList.remove('fa-sun');
                themeIcon.classList.add('fa-moon');
            }
        }

        function setTheme(theme) {
            docElement.setAttribute('data-bs-theme', theme);
            localStorage.setItem('theme', theme);
            const isDark = theme === 'dark';
            themeSwitcher.checked = isDark;
            themeSwitcherDesktop.checked = isDark;
            setIconForTheme(theme);
        }

        themeSwitcher.addEventListener('change', () => {
            const newTheme = themeSwitcher.checked ? 'dark' : 'light';
            setTheme(newTheme);
        });

        themeSwitcherDesktop.addEventListener('change', () => {
            const newTheme = themeSwitcherDesktop.checked ? 'dark' : 'light';
            setTheme(newTheme);
        });

        // Define o tema inicial com base no localStorage ou preferência do SO
        const storedTheme = localStorage.getItem('theme');
        const preferredTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        const initialTheme = storedTheme || preferredTheme;
        setTheme(initialTheme);

        // Ouve mudanças na preferência do SO
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
            const newTheme = e.matches ? 'dark' : 'light';
            setTheme(newTheme);
        });

        const pages = document.querySelectorAll('.page');

        function showPage(pageId) {
            pages.forEach(page => {
                page.classList.remove('active');
            });
            const newPage = document.getElementById(pageId);
            if (newPage) {
                newPage.classList.add('active');
                window.scrollTo(0, 0);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Navegação inicial
            showPage('page-home');

            // Lógica do formulário de rescisão
            const tipoRescisaoSelect = document.getElementById('tipo_rescisao');
            const avisoPedidoDemissaoDiv = document.getElementById('aviso_pedido_demissao');
            const avisoSemJustaCausaDiv = document.getElementById('aviso_sem_justa_causa');
            const dataFimInput = document.querySelector('input[name="data_fim"]');
            const dataFimDiv = document.getElementById('data_fim_div');
            const dataSolicitacaoInput = document.getElementById('data_solicitacao_demissao');
            const dataSaidaPretendidaDiv = document.getElementById('data_saida_pretendida_div');
            const feriasVencidasDiv = document.getElementById('ferias_vencidas_div');
            const dataInicioInput = document.querySelector('input[name="data_inicio"]');

            tipoRescisaoSelect.addEventListener('change', (e) => {
                const tipo = e.target.value;
                avisoPedidoDemissaoDiv.style.display = tipo === 'pedido_demissao' ? 'block' : 'none';
                avisoSemJustaCausaDiv.style.display = tipo === 'sem_justa_causa' ? 'block' : 'none';
                dataFimInput.required = tipo !== 'pedido_demissao';
                dataFimDiv.style.display = tipo === 'pedido_demissao' ? 'none' : 'block';
                dataSolicitacaoInput.required = tipo === 'pedido_demissao';
                toggleFeriasVencidasVisibility();
            });

            document.querySelectorAll('input[name="cumprira_aviso"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const dataSaidaInput = dataSaidaPretendidaDiv.querySelector('input');
                    if (e.target.value === 'nao') {
                        dataSaidaPretendidaDiv.style.display = 'block';
                        dataSaidaInput.required = true;
                    } else {
                        dataSaidaPretendidaDiv.style.display = 'none';
                        dataSaidaInput.required = false;
                    }
                });
            });

            function toggleFeriasVencidasVisibility() {
                const dataInicio = parseDate(dataInicioInput.value);
                let dataReferencia;

                const tipo = tipoRescisaoSelect.value;

                if (tipo === 'pedido_demissao') {
                    dataReferencia = parseDate(dataSolicitacaoInput.value);
                } else {
                    dataReferencia = parseDate(dataFimInput.value);
                }

                if (dataInicio && dataReferencia && !isNaN(dataInicio) && !isNaN(dataReferencia)) {
                    const diffMeses = diffInMonths(dataInicio, dataReferencia);
                    feriasVencidasDiv.style.display = diffMeses >= 12 ? 'block' : 'none';
                } else {
                    feriasVencidasDiv.style.display = 'none';
                }
            }

            [dataInicioInput, dataFimInput, dataSolicitacaoInput].forEach(input => {
                input.addEventListener('change', toggleFeriasVencidasVisibility);
            });

            // Disparar o change para configurar o estado inicial
            tipoRescisaoSelect.dispatchEvent(new Event('change'));
            document.querySelector('input[name="cumprira_aviso"]:checked').dispatchEvent(new Event('change'));
            toggleFeriasVencidasVisibility();

            // Handlers de submit dos formulários
            document.getElementById('form-rescisao').addEventListener('submit', handleRescisaoSubmit);
            document.getElementById('form-salario').addEventListener('submit', handleSalarioSubmit);

            // Inicializar Histórico
            renderHistorico();
        });


        // ===================================================================================
        // LÓGICA DE CÁLCULO (JAVASCRIPT)
        // ===================================================================================

        const TipoRescisao = {
            SEM_JUSTA_CAUSA: "sem_justa_causa",
            PEDIDO_DEMISSAO: "pedido_demissao",
            JUSTA_CAUSA: "justa_causa",
            ACORDO: "acordo",
            TERMINO_CONTRATO: "termino_contrato"
        };

        // Tabelas de 2025 (exemplo) - confirmar valores oficiais
        const TABELA_INSS = [
            { limite: 1518.00, aliquota: 0.075 },
            { limite: 2793.88, aliquota: 0.09 },
            { limite: 4190.83, aliquota: 0.12 },
            { limite: 8157.41, aliquota: 0.14 },
        ];

        const TABELA_IRRF = [
            { limite: 2428.80, aliquota: 0.0, deducao: 0.00 },
            { limite: 2826.65, aliquota: 0.075, deducao: 182.16 },
            { limite: 3751.05, aliquota: 0.15, deducao: 394.16 },
            { limite: 4664.68, aliquota: 0.225, deducao: 675.49 },
            { limite: Infinity, aliquota: 0.275, deducao: 908.73 },
        ];

        const DEDUCAO_DEPENDENTE_IRRF = 189.59;

        // Funções de utilidade de data
        function parseDate(dateString) {
            // Adiciona T00:00:00 para evitar problemas de fuso horário
            return new Date(dateString + 'T00:00:00');
        }

        function addMonths(date, months) {
            const d = new Date(date);
            d.setMonth(d.getMonth() + months);
            return d;
        }

        function diffInMonths(date1, date2) {
            let months;
            months = (date2.getFullYear() - date1.getFullYear()) * 12;
            months -= date1.getMonth();
            months += date2.getMonth();
            return months <= 0 ? 0 : months;
        }

        function diffInDays(date1, date2) {
            const oneDay = 24 * 60 * 60 * 1000;
            return Math.round(Math.abs((date1 - date2) / oneDay));
        }

        // Funções de cálculo de verbas
        function saldo_salario(salario, dias) {
            const valor = (salario / 30) * dias;
            const calculo = `(Salário R$ ${salario.toFixed(2)} / 30 dias) * ${dias} dias trabalhados.`;
            return { valor, calculo };
        }

        function aviso_previo(salario, devido, cumprido, tipo_rescisao) {
            let dias_a_pagar = devido - cumprido;
            const valor_dia = salario / 30;
            let valor = valor_dia * dias_a_pagar;
            let calculo = "";

            if (tipo_rescisao === TipoRescisao.PEDIDO_DEMISSAO) {
                if (dias_a_pagar > 0) { // Apenas se não cumpriu tudo
                    valor *= -1;
                    calculo = `Desconto de ${Math.abs(dias_a_pagar)} dias de aviso não cumprido. (R$ ${salario.toFixed(2)} / 30) * ${Math.abs(dias_a_pagar)}.`;
                } else {
                    valor = 0;
                    calculo = "Aviso prévio cumprido integralmente.";
                }
            } else {
                valor = Math.max(0, valor);
                if (valor > 0) {
                    calculo = `Aviso indenizado de ${dias_a_pagar} dias. (R$ ${salario.toFixed(2)} / 30) * ${dias_a_pagar}.`;
                } else {
                    calculo = "Aviso prévio trabalhado/cumprido.";
                }
            }
            return { valor, calculo };
        }

        function ferias_vencidas(salario, periodos, dobro) {
            if (periodos <= 0) {
                return { valor: 0, calculo: "Nenhum período de férias vencidas." };
            }
            let base = salario * periodos;
            let calculo_base = `Salário (R$ ${salario.toFixed(2)}) * ${periodos} período(s)`;
            if (dobro) {
                base *= 2;
                calculo_base += " (em dobro)";
            }
            const terco = base / 3;
            const valor = base + terco;
            const calculo = `${calculo_base} + 1/3 sobre o valor (R$ ${terco.toFixed(2)}).`;
            return { valor, calculo };
        }

        function ferias_proporcionais(salario, meses) {
            const meses_validos = meses % 12;
            if (meses_validos === 0) {
                return { valor: 0, calculo: "Nenhum mês para férias proporcionais." };
            }
            const base = (salario / 12) * meses_validos;
            const terco = base / 3;
            const valor = base + terco;
            const calculo = `(${meses_validos}/12 avos de R$ ${salario.toFixed(2)}) + 1/3 sobre o valor (R$ ${terco.toFixed(2)}).`;
            return { valor, calculo };
        }

        function decimo_terceiro(salario, meses) {
            const valor = (salario / 12) * meses;
            const calculo = `${meses}/12 avos de R$ ${salario.toFixed(2)}.`;
            return { valor, calculo };
        }

        // Funções de cálculo de impostos
        function calcular_inss(base_calculo, tipo_verba = "") {
            let inss = 0.0;
            let limite_anterior = 0.0;
            let calculo_str = `Cálculo progressivo sobre a base (${tipo_verba}) de R$ ${base_calculo.toFixed(2)}:\n`;

            for (const faixa of TABELA_INSS) {
                const limite = faixa.limite;
                const aliquota = faixa.aliquota;

                if (base_calculo > limite_anterior) {
                    const base_faixa = Math.min(base_calculo, limite) - limite_anterior;
                    const valor_faixa = base_faixa * aliquota;
                    inss += valor_faixa;
                    calculo_str += `  - Faixa até R$ ${limite.toFixed(2)}: (R$ ${base_faixa.toFixed(2)} * ${aliquota * 100}%) = R$ ${valor_faixa.toFixed(2)}\n`;
                    limite_anterior = limite;
                } else {
                    break;
                }
            }
            return { valor: parseFloat(inss.toFixed(2)), calculo: calculo_str.trim() };
        }

        function calcular_irrf(base_calculo, num_dependentes = 0, tipo_verba = "") {
            const deducao_dependentes = DEDUCAO_DEPENDENTE_IRRF * num_dependentes;
            const base_irrf = base_calculo - deducao_dependentes;

            let aliquota = 0.0, deducao = 0.0;
            for (const faixa of TABELA_IRRF) {
                if (base_irrf <= faixa.limite) {
                    aliquota = faixa.aliquota;
                    deducao = faixa.deducao;
                    break;
                }
            }

            const valor = (base_irrf * aliquota) - deducao;
            const calculo = `Base de cálculo (${tipo_verba}): R$ ${base_calculo.toFixed(2)}. Base p/ IRRF (já deduzido INSS e ${num_dependentes} dependente(s)): R$ ${base_irrf.toFixed(2)}. Fórmula: (R$ ${base_irrf.toFixed(2)} * ${aliquota * 100}%) - R$ ${deducao.toFixed(2)}.`;
            return { valor: Math.max(0, parseFloat(valor.toFixed(2))), calculo };
        }

        function calcular_impostos_rescisao(verbas, num_dependentes) {
            const base_inss_mes = verbas["Saldo de salário"]?.valor || 0;
            const base_inss_13 = verbas["13º salário proporcional"]?.valor || 0;

            const inss_salario_detalhe = calcular_inss(base_inss_mes, "Saldo Salário");
            const inss_13_detalhe = calcular_inss(base_inss_13, "13º");

            // IRRF sobre 13º
            const base_irrf_13 = base_inss_13 - inss_13_detalhe.valor;
            const irrf_13_detalhe = calcular_irrf(base_irrf_13, num_dependentes, "13º Salário");

            // IRRF sobre outras verbas
            const saldo_salario_valor = verbas["Saldo de salário"]?.valor || 0;
            const ferias_vencidas_valor = verbas["Férias vencidas"]?.valor || 0;
            const ferias_proporcionais_valor = verbas["Férias proporcionais"]?.valor || 0;
            const total_ferias = ferias_vencidas_valor + ferias_proporcionais_valor;

            const base_calculo_irrf_mes = saldo_salario_valor + total_ferias;
            const base_irrf_mes = base_calculo_irrf_mes - inss_salario_detalhe.valor;

            const tipo_verba_detalhado = `Saldo Salário (R$ ${saldo_salario_valor.toFixed(2)}) + Férias (R$ ${total_ferias.toFixed(2)})`;
            const irrf_mes_detalhe = calcular_irrf(base_irrf_mes, num_dependentes, tipo_verba_detalhado);

            const descontos = {};
            if (inss_salario_detalhe.valor > 0) descontos["(-) Desconto INSS sobre Saldo Salário"] = inss_salario_detalhe;
            if (inss_13_detalhe.valor > 0) descontos["(-) Desconto INSS sobre 13º"] = inss_13_detalhe;
            if (irrf_mes_detalhe.valor > 0) descontos["(-) Desconto IRRF sobre Salário/Férias"] = irrf_mes_detalhe;
            if (irrf_13_detalhe.valor > 0) descontos["(-) Desconto IRRF sobre 13º"] = irrf_13_detalhe;

            const total_inss = inss_salario_detalhe.valor + inss_13_detalhe.valor;
            const total_irrf = irrf_13_detalhe.valor + irrf_mes_detalhe.valor;

            if (Object.keys(descontos).length > 0) {
                descontos["Total de Descontos"] = { valor: total_inss + total_irrf, calculo: "Soma de todos os descontos de INSS e IRRF." };
            }

            return descontos;
        }


        // Funções principais de cálculo
        function calcular_rescisao(dados, tipo) {
            let r = {};

            r["Saldo de salário"] = saldo_salario(dados.salario, dados.dias_trabalhados_saldo);

            if (tipo !== TipoRescisao.JUSTA_CAUSA) {
                r["Férias vencidas"] = ferias_vencidas(dados.salario, dados.ferias_vencidas, dados.ferias_em_dobro);
                r["Férias proporcionais"] = ferias_proporcionais(dados.salario, dados.meses_trabalhados_ferias);
                r["13º salário proporcional"] = decimo_terceiro(dados.salario, dados.meses_trabalhados_13);
            } else {
                r["Férias vencidas"] = { valor: 0, calculo: "Não aplicável para justa causa." };
                r["Férias proporcionais"] = { valor: 0, calculo: "Não aplicável para justa causa." };
                r["13º salário proporcional"] = { valor: 0, calculo: "Não aplicável para justa causa." };
            }

            // Aviso prévio é tratado de forma diferente para cada tipo
            if (tipo === TipoRescisao.PEDIDO_DEMISSAO || tipo === TipoRescisao.SEM_JUSTA_CAUSA) {
                r["Aviso prévio"] = aviso_previo(dados.salario, dados.dias_aviso_devido, dados.dias_aviso_cumprido, tipo);
            } else {
                r["Aviso prévio"] = { valor: 0, calculo: "Não aplicável para este tipo de rescisão." };
            }

            const verbas_brutas = Object.fromEntries(Object.entries(r).filter(([_, v]) => v.valor !== 0));

            const total_bruto = Object.values(verbas_brutas).reduce((sum, v) => sum + (v.valor > 0 ? v.valor : 0), 0);
            verbas_brutas["Total Bruto"] = { valor: total_bruto, calculo: "Soma de todas as verbas rescisórias." };

            return verbas_brutas;
        }

        function sugerir_salario_pj(salario_bruto, bonus_anual, va_vr_mensal) {
            const salario_anual = salario_bruto * 12;
            const decimo_terceiro = salario_bruto;
            const terco_ferias = salario_bruto / 3;
            const fgts_anual = salario_anual * 0.08;
            const va_vr_anual = va_vr_mensal * 12;

            const total_anual_clt = salario_anual + decimo_terceiro + terco_ferias + fgts_anual + va_vr_anual + bonus_anual;
            const salario_pj_sugerido = total_anual_clt / 12;

            const calculo = `
                Salário Anual (12x): R$ ${salario_anual.toFixed(2)}\n
                + 13º Salário: R$ ${decimo_terceiro.toFixed(2)}\n
                + 1/3 de Férias: R$ ${terco_ferias.toFixed(2)}\n
                + FGTS Anual (8%): R$ ${fgts_anual.toFixed(2)}\n
                + VA/VR Anual (12x): R$ ${va_vr_anual.toFixed(2)}\n
                + Bônus/PLR Anual: R$ ${bonus_anual.toFixed(2)}\n
                --------------------------------------------------\n
                = Total Anualizado CLT: R$ ${total_anual_clt.toFixed(2)}\n
                ÷ 12 meses\n
                --------------------------------------------------\n
                = Salário PJ Mensal Sugerido: R$ ${salario_pj_sugerido.toFixed(2)}
            `;
            return { valor: salario_pj_sugerido, calculo };
        }

        function calcular_salario_liquido(salario_bruto, num_dependentes, bonus_anual, va_vr_mensal) {
            const inss_detalhe = calcular_inss(salario_bruto, "Salário Bruto");
            const inss_valor = inss_detalhe.valor;

            const base_calculo_irrf = salario_bruto - inss_valor;
            const irrf_detalhe = calcular_irrf(base_calculo_irrf, num_dependentes, "Salário Bruto");
            const irrf_valor = irrf_detalhe.valor;

            const salario_liquido = salario_bruto - inss_valor - irrf_valor;

            const sugestao_pj = sugerir_salario_pj(salario_bruto, bonus_anual, va_vr_mensal);

            const valor_hora_clt = salario_bruto / 220;
            const valor_hora_pj = sugestao_pj.valor / 168;

            return {
                "Salário Bruto": { valor: salario_bruto, calculo: "Valor base informado." },
                "(-) Desconto INSS": inss_detalhe,
                "(-) Desconto IRRF": irrf_detalhe,
                "Salário Líquido": {
                    valor: salario_liquido,
                    calculo: `Salário Bruto (R$ ${salario_bruto.toFixed(2)}) - INSS (R$ ${inss_valor.toFixed(2)}) - IRRF (R$ ${irrf_valor.toFixed(2)})`,
                },
                "Sugestão Salário PJ": sugestao_pj,
                "Valores por Hora": {
                    clt: {
                        valor: valor_hora_clt,
                        calculo: `Salário Bruto (R$ ${salario_bruto.toFixed(2)}) ÷ 220 horas`,
                    },
                    pj: {
                        valor: valor_hora_pj,
                        calculo: `Salário PJ (R$ ${sugestao_pj.valor.toFixed(2)}) ÷ 168 horas`
                    },
                },
            };
        }

        // ===================================================================================
        // HANDLERS DE SUBMIT E RENDERIZAÇÃO
        // ===================================================================================

        function handleRescisaoSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            const tipo = data.tipo_rescisao;
            const data_inicio = parseDate(data.data_inicio);
            let data_fim;

            let dias_aviso_devido = 0;
            let dias_aviso_cumprido = 0;

            if (tipo === TipoRescisao.PEDIDO_DEMISSAO) {
                const data_solicitacao = parseDate(data.data_solicitacao_demissao);
                dias_aviso_devido = 30;
                if (data.cumprira_aviso === 'sim') {
                    dias_aviso_cumprido = 30;
                    data_fim = new Date(data_solicitacao);
                    data_fim.setDate(data_fim.getDate() + 30);
                } else {
                    data_fim = parseDate(data.data_saida_pretendida);
                    dias_aviso_cumprido = diffInDays(data_solicitacao, data_fim);
                    dias_aviso_cumprido = Math.max(0, Math.min(dias_aviso_cumprido, 30));
                }
            } else {
                data_fim = parseDate(data.data_fim);
                if (tipo === TipoRescisao.SEM_JUSTA_CAUSA) {
                    const anos_trabalhados = Math.floor(diffInDays(data_inicio, data_fim) / 365);
                    dias_aviso_devido = 30 + (Math.min(20, anos_trabalhados) * 3); // Limite de 90 dias
                    if (data.tipo_aviso_sem_justa_causa === 'trabalhado') {
                        dias_aviso_cumprido = dias_aviso_devido;
                    } else {
                        dias_aviso_cumprido = 0;
                    }
                }
            }

            const dia_pagamento = parseInt(data.dia_pagamento);
            let data_inicio_saldo;
            if (data_fim.getDate() >= dia_pagamento) {
                data_inicio_saldo = new Date(data_fim.getFullYear(), data_fim.getMonth(), dia_pagamento);
            } else {
                data_inicio_saldo = new Date(data_fim.getFullYear(), data_fim.getMonth() - 1, dia_pagamento);
            }
            const dias_trabalhados_saldo = diffInDays(data_inicio_saldo, data_fim) + 1;

            let meses_para_13 = data_fim.getMonth() + 1;
            if (data_fim.getDate() < 15) {
                meses_para_13 -= 1;
            }
            if (data_inicio.getFullYear() === data_fim.getFullYear()) {
                meses_para_13 -= data_inicio.getMonth();
                if (data_inicio.getDate() > 15) {
                    meses_para_13 -= 1;
                }
            }

            const meses_trabalhados_ferias = diffInMonths(data_inicio, data_fim) + (data_fim.getDate() >= data_inicio.getDate() ? 1 : 0);

            const dadosEmpregado = {
                salario: parseFloat(data.salario),
                meses_trabalhados_ferias: meses_trabalhados_ferias,
                meses_trabalhados_13: Math.max(0, meses_para_13),
                dias_trabalhados_saldo: dias_trabalhados_saldo,
                dias_aviso_devido: dias_aviso_devido,
                dias_aviso_cumprido: dias_aviso_cumprido,
                ferias_vencidas: data.tem_ferias_vencidas ? 1 : 0,
                ferias_em_dobro: false, // Simplificado, pode ser adicionado no form
            };

            const verbas = calcular_rescisao(dadosEmpregado, tipo);
            const impostos = calcular_impostos_rescisao(verbas, 0); // Num dependentes simplificado para 0

            const resultado = { ...verbas, ...impostos };
            const total_bruto = verbas["Total Bruto"]?.valor || 0;
            const total_descontos_impostos = impostos["Total de Descontos"]?.valor || 0;
            const desconto_aviso = verbas["Aviso prévio"]?.valor < 0 ? verbas["Aviso prévio"].valor : 0;
            const liquido = total_bruto + desconto_aviso - total_descontos_impostos;

            resultado["Líquido a Receber"] = {
                valor: liquido,
                calculo: `Total Bruto (R$ ${total_bruto.toFixed(2)}) - Descontos (R$ ${(total_descontos_impostos + Math.abs(desconto_aviso)).toFixed(2)})`
            };

            renderRescisaoResult(resultado);
            saveToHistory('Rescisão', data, resultado);
        }

        function handleSalarioSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);

            const salario_bruto = parseFloat(formData.get("salario_bruto") || 0);
            const num_dependentes = parseInt(formData.get("num_dependentes") || 0);
            const bonus_anual = parseFloat(formData.get("bonus_anual") || 0);
            const va_vr_mensal = parseFloat(formData.get("va_vr_mensal") || 0);

            if (salario_bruto > 0) {
                const resultado = calcular_salario_liquido(salario_bruto, num_dependentes, bonus_anual, va_vr_mensal);
                renderSalarioResult(resultado);
                const inputData = { salario_bruto, num_dependentes, bonus_anual, va_vr_mensal };
                saveToHistory('Salário', inputData, resultado);
            }
        }

        function renderRescisaoResult(resultado) {
            const container = document.getElementById('resultado-rescisao-content');
            document.getElementById('rescisao-placeholder')?.remove();

            const headerHtml = `
                <div class="d-flex justify-content-between align-items-center mb-3 no-print">
                    <h2>Resultado da Rescisão</h2>
                    <button type="button" class="btn btn-sm btn-outline-success" onclick="window.print()">
                        <i class="fas fa-print"></i> Imprimir / Salvar PDF
                    </button>
                </div>
            `;

            let verbasHtml = '<div class="card p-4 mb-3"><table class="table table-striped"><caption>Verbas Rescisórias (Recebimentos)</caption><thead class="table-success"><tr><th>Verba</th><th class="text-end">Valor (R$)</th></tr></thead><tbody>';
            for (const [item, data] of Object.entries(resultado)) {
                if (data.valor > 0 && !item.includes('Total') && !item.includes('Líquido') && !item.includes('Desconto')) {
                    verbasHtml += `
                        <tr data-bs-toggle="collapse" href="#collapse-v-${item.replace(/\s/g, '')}" role="button">
                            <td><strong>${item} <i class="fas fa-info-circle text-muted"></i></strong></td>
                            <td class="text-end"><strong>${data.valor.toFixed(2)}</strong></td>
                        </tr>
                        <tr class="collapse" id="collapse-v-${item.replace(/\s/g, '')}">
                            <td colspan="2" class="p-3" style="background-color: var(--info-bg);"><small><strong>Como chegamos neste valor:</strong><br><pre class="mb-0">${data.calculo}</pre></small></td>
                        </tr>`;
                }
            }
            verbasHtml += `
                <tr class="table-light">
                    <td><strong>Total Bruto</strong></td>
                    <td class="text-end"><strong>${(resultado['Total Bruto']?.valor || 0).toFixed(2)}</strong></td>
                </tr>
            </tbody></table></div>`;

            let descontosHtml = '<div class="card p-4 mb-3"><table class="table table-striped"><caption>Descontos</caption><thead class="table-danger"><tr><th>Desconto</th><th class="text-end">Valor (R$)</th></tr></thead><tbody>';
            let totalDescontosFinal = 0;
            for (const [item, data] of Object.entries(resultado)) {
                if ((data.valor < 0 && item.includes('Aviso')) || (item.includes('Desconto') && !item.includes('Total'))) {
                    totalDescontosFinal += Math.abs(data.valor);
                    descontosHtml += `
                        <tr data-bs-toggle="collapse" href="#collapse-d-${item.replace(/\s/g, '')}" role="button">
                            <td><strong>${item.replace('(-)', '').trim()} <i class="fas fa-info-circle text-muted"></i></strong></td>
                            <td class="text-end"><strong>${data.valor.toFixed(2)}</strong></td>
                        </tr>
                        <tr class="collapse" id="collapse-d-${item.replace(/\s/g, '')}">
                            <td colspan="2" class="p-3" style="background-color: var(--danger-info-bg);"><small><strong>Como chegamos neste valor:</strong><br><pre class="mb-0">${data.calculo}</pre></small></td>
                        </tr>`;
                }
            }
            descontosHtml += `
                <tr class="table-light">
                    <td><strong>Total de Descontos</strong></td>
                    <td class="text-end"><strong>-${totalDescontosFinal.toFixed(2)}</strong></td>
                </tr>
            </tbody></table></div>`;

            const liquidoHtml = `
                <div class="alert alert-primary text-center mt-4">
                    <h3>Líquido a Receber: R$ ${(resultado['Líquido a Receber']?.valor || 0).toFixed(2)}</h3>
                </div>`;

            container.innerHTML = headerHtml + verbasHtml + descontosHtml + liquidoHtml;
        }

        function renderSalarioResult(resultado) {
            const container = document.getElementById('resultado-salario-content');
            document.getElementById('salario-placeholder')?.remove();

            const headerHtml = `
                <div class="d-flex justify-content-between align-items-center mb-3 no-print">
                    <h2>Resultado do Salário</h2>
                    <button type="button" class="btn btn-sm btn-outline-success" onclick="window.print()">
                        <i class="fas fa-print"></i> Imprimir / Salvar Relatório
                    </button>
                </div>
            `;

            const salarioBruto = resultado['Salário Bruto'].valor;
            const inss = resultado['(-) Desconto INSS'];
            const irrf = resultado['(-) Desconto IRRF'];
            const salarioLiquido = resultado['Salário Líquido'];
            const sugestaoPj = resultado['Sugestão Salário PJ'];
            const valoresHora = resultado['Valores por Hora'];

            const contentHtml = `
                <div class="card p-4 mb-3">
                    <h3 class="mb-3">Demonstrativo de Pagamento (CLT)</h3>
                    <table class="table">
                        <tr>
                            <td>Salário Bruto</td>
                            <td class="text-end">R$ ${salarioBruto.toFixed(2)}</td>
                        </tr>
                        <tr class="text-danger" data-bs-toggle="collapse" href="#collapse-inss-sal" role="button">
                            <td>(-) Desconto INSS <i class="fas fa-info-circle text-muted"></i></td>
                            <td class="text-end">- R$ ${inss.valor.toFixed(2)}</td>
                        </tr>
                        <tr class="collapse" id="collapse-inss-sal"><td colspan="2" class="p-3" style="background-color: var(--danger-info-bg);"><small><pre>${inss.calculo}</pre></small></td></tr>
                        <tr class="text-danger" data-bs-toggle="collapse" href="#collapse-irrf-sal" role="button">
                            <td>(-) Desconto IRRF <i class="fas fa-info-circle text-muted"></i></td>
                            <td class="text-end">- R$ ${irrf.valor.toFixed(2)}</td>
                        </tr>
                        <tr class="collapse" id="collapse-irrf-sal"><td colspan="2" class="p-3" style="background-color: var(--danger-info-bg);"><small><pre>${irrf.calculo}</pre></small></td></tr>
                        <tr class="fw-bold table-success">
                            <td>Salário Líquido a Receber</td>
                            <td class="text-end">R$ ${salarioLiquido.valor.toFixed(2)}</td>
                        </tr>
                    </table>
                </div>

                <div class="card p-4 mb-3">
                    <h3 class="mb-3">Comparativo CLT x PJ</h3>
                    <div class="row">
                        <div class="col-md-6">
                            <h4><i class="fas fa-user-tie"></i> Modelo CLT</h4>
                            <p><strong>Salário Líquido: R$ ${salarioLiquido.valor.toFixed(2)}</strong></p>
                            <p class="text-muted" data-bs-toggle="collapse" href="#collapse-clt-hora" role="button">
                                Valor/Hora: R$ ${valoresHora.clt.valor.toFixed(2)} <i class="fas fa-info-circle"></i>
                            </p>
                            <div class="collapse" id="collapse-clt-hora"><small><pre>${valoresHora.clt.calculo}</pre></small></div>
                        </div>
                        <div class="col-md-6">
                            <h4><i class="fas fa-briefcase"></i> Modelo PJ</h4>
                            <p class="text-success" data-bs-toggle="collapse" href="#collapse-pj-sugestao" role="button">
                                <strong>Salário Sugerido: R$ ${sugestaoPj.valor.toFixed(2)}</strong> <i class="fas fa-info-circle"></i>
                            </p>
                             <div class="collapse" id="collapse-pj-sugestao"><small><pre>${sugestaoPj.calculo}</pre></small></div>
                            <p class="text-muted" data-bs-toggle="collapse" href="#collapse-pj-hora" role="button">
                                Valor/Hora: R$ ${valoresHora.pj.valor.toFixed(2)} <i class="fas fa-info-circle"></i>
                            </p>
                            <div class="collapse" id="collapse-pj-hora"><small><pre>${valoresHora.pj.calculo}</pre></small></div>
                        </div>
                    </div>
                </div>
            `;

            container.innerHTML = headerHtml + contentHtml;
        }

        // ===================================================================================
        // ANALYTICS E HISTÓRICO (LOCALSTORAGE)
        // ===================================================================================

        function trackEvent(name, params) {
            if (typeof gtag === 'function') {
                gtag('event', name, params);
            }
            console.log(`[Analytics] Event: ${name}`, params);
        }

        function saveToHistory(type, input, output) {
            const history = JSON.parse(localStorage.getItem('calculadora_historico') || '[]');
            const entry = {
                id: Date.now(),
                timestamp: new Date().toISOString(),
                type: type,
                input: input,
                output: {
                    liquido: output['Líquido a Receber']?.valor || output['Salário Líquido']?.valor || 0
                }
            };

            history.unshift(entry);
            if (history.length > 50) history.pop();

            localStorage.setItem('calculadora_historico', JSON.stringify(history));
            renderHistorico();

            trackEvent('calculation', {
                calculation_type: type,
                value: entry.output.liquido,
                ...input
            });
        }

        function renderHistorico() {
            const history = JSON.parse(localStorage.getItem('calculadora_historico') || '[]');
            const body = document.getElementById('historico-body');
            const emptyState = document.getElementById('historico-vazio');

            if (!body) return;

            if (history.length === 0) {
                body.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';
            body.innerHTML = history.map(entry => {
                const date = new Date(entry.timestamp).toLocaleString('pt-BR');
                const destaque = entry.output.liquido.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                const icon = entry.type === 'Rescisão' ? 'fa-file-invoice-dollar' : 'fa-hand-holding-dollar';

                return `
                    <tr>
                        <td class="ps-3 border-start border-4 border-primary">${date}</td>
                        <td><i class="fas ${icon} me-2 text-primary"></i>${entry.type}</td>
                        <td class="fw-bold">${destaque}</td>
                        <td class="text-end pe-3">
                            <button class="btn btn-sm btn-outline-info" onclick='verDetalhesHistorico(${JSON.stringify(entry.id)})'>
                                <i class="fas fa-search-plus"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function limparHistorico() {
            if (confirm('Deseja realmente limpar todo o histórico?')) {
                localStorage.removeItem('calculadora_historico');
                renderHistorico();
                trackEvent('history_clear', {});
            }
        }

        function verDetalhesHistorico(id) {
            const history = JSON.parse(localStorage.getItem('calculadora_historico') || '[]');
            const entry = history.find(e => e.id === id);
            if (entry) {
                alert(`Detalhes do cálculo (${entry.type}):\n\nInputs: ${JSON.stringify(entry.input, null, 2)}\n\nResultado Simplificado: ${JSON.stringify(entry.output, null, 2)}`);
            }
        }

        function exportarHistorico() {
            const history = localStorage.getItem('calculadora_historico') || '[]';
            const blob = new Blob([history], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `historico_calculadora_clt_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            trackEvent('history_export', {});
        }

    </script>
</body>

</html>